<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoice Generator ‚Äî Áé≤ÁìèÂúãÈöõ Exquis International</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg-1:#667eea; --bg-2:#764ba2; --ink:#1f2937; --muted:#6b7280; --ring:#a5b4fc;
    }
    *{box-sizing:border-box}
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Arial, sans-serif; background:linear-gradient(135deg,var(--bg-1),var(--bg-2)); min-height:100vh; padding:24px}
    .container{max-width:960px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.12);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:28px 32px}
    .header h1{font-size:28px;margin:0 0 6px}
    .header p{opacity:.9;margin:0}
    .form{padding:32px}
    .section{margin:0 0 24px;padding:20px;background:linear-gradient(135deg,#f8f9fa,#eef2f7);border-left:5px solid var(--bg-1);border-radius:14px}
    .section h2{font-size:18px;margin:0 0 12px;color:#111827}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .group{display:flex;flex-direction:column}
    .group.full{grid-column:1 / -1}
    label{font-weight:600;color:#111827;margin:0 0 6px}
    input,textarea,select{padding:12px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;background:#fff}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 3px rgba(165,180,252,.25)}
    textarea{min-height:80px;resize:vertical}

    .items h2{display:flex;align-items:center;gap:8px}
    .item-row{display:grid;grid-template-columns:80px 2fr 80px 100px 120px 40px;gap:12px;align-items:end;margin:12px 0;padding:16px;border:2px solid #eef2f7;border-radius:12px;background:#fff}
    .item-row:hover{border-color:#c7d2fe;transform:translateY(-1px);transition:all .2s}
    .btn{border:0;border-radius:10px;padding:10px 16px;color:#fff;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));cursor:pointer}
    .btn.secondary{background:linear-gradient(135deg,#9ca3af,#6b7280)}
    .btn.remove{background:linear-gradient(135deg,#ef4444,#b91c1c);width:40px;height:40px;font-size:20px;line-height:0}
    .actions{display:flex;gap:10px;justify-content:center;border-top:2px solid #eef2f7;margin-top:24px;padding-top:24px}
    .total-card{background:linear-gradient(135deg,#111827,#334155);color:#fff;padding:20px;border-radius:14px;text-align:center;margin-top:16px}
    .total-card h3{margin:0 0 6px}
    .total-amount{font-size:24px;font-weight:800}
    @media (max-width: 820px){
      .row{grid-template-columns:1fr}
      .item-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Áé≤ÁìèÂúãÈöõ Exquis International</h1>
      <p>Invoice Generator</p>
    </div>

    <form id="invoiceForm" class="form">
      <div class="section">
        <h2>Invoice Information</h2>
        <div class="row">
          <div class="group">
            <label for="invoiceNo">Invoice No.</label>
            <input id="invoiceNo" name="invoiceNo" required />
          </div>
          <div class="group">
            <label for="invoiceDate">Date</label>
            <input type="date" id="invoiceDate" name="invoiceDate" required />
          </div>
        </div>
      </div>

      <div class="section">
        <h2>Client Information</h2>
        <div class="row">
          <div class="group full">
            <label for="clientTo">To / Êî∂‰ª∂‰∫∫</label>
            <input id="clientTo" name="clientTo" required />
          </div>
        </div>
        <div class="row">
          <div class="group full">
            <label for="clientAddress">Address / Âú∞ÂùÄ</label>
            <textarea id="clientAddress" name="clientAddress" rows="3"></textarea>
          </div>
        </div>
        <div class="row">
          <div class="group">
            <label for="clientTel">Tel / ÈõªË©±</label>
            <input id="clientTel" name="clientTel" />
          </div>
          <div class="group">
            <label for="clientAttn">Attn / ËÅØÁµ°‰∫∫</label>
            <input id="clientAttn" name="clientAttn" />
          </div>
        </div>
      </div>

      <div class="section items">
        <h2>üìù Invoice Items</h2>
        <div id="itemsContainer"></div>
        <button class="btn secondary" type="button" id="addItemBtn">Add Item</button>
      </div>

      <div class="section">
        <h2>Payment Method / ‰ªòÊ¨æÊñπÂºè</h2>
        <div class="row">
          <div class="group full">
            <label for="paymentMethod">Payment Method / ‰ªòÊ¨æÊñπÂºè</label>
            <textarea id="paymentMethod" name="paymentMethod" rows="2" placeholder="Bank transfer, Cash, Cheque, etc."></textarea>
          </div>
        </div>
      </div>

      <div class="total-card">
        <h3>Total Amount / Á∏ΩÈáëÈ°ç</h3>
        <div id="totalAmount" class="total-amount">$0.00</div>
      </div>

      <div class="actions">
        <button class="btn" type="button" id="generateBtn">Generate PDF Invoice</button>
      </div>
    </form>
  </div>

  <script>
    // ===== Utilities =====
    const currency = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'HKD',minimumFractionDigits:2}).format(Number(n||0));
    let itemCount = 0;

    window.addEventListener('load', ()=>{
      addItem();
      document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
    });

    document.getElementById('addItemBtn').addEventListener('click', addItem);
    document.getElementById('generateBtn').addEventListener('click', ()=> generatePDF().catch(err=>{alert('Failed to generate PDF: '+err.message);}));

    function addItem(){
      itemCount++;
      const el = document.createElement('div');
      el.className='item-row';
      el.id = `item-${itemCount}`;
      el.innerHTML = `
        <div class="group"><label>Item No.</label><input name="itemNo" value="${itemCount}"/></div>
        <div class="group"><label>Description / ÊèèËø∞</label><input name="description" required/></div>
        <div class="group"><label>Qty / Êï∏Èáè</label><input type="number" name="qty" min="1" value="1" oninput="calculateTotal()" required/></div>
        <div class="group"><label>Unit Price / ÂñÆÂÉπ</label><input type="number" name="unitPrice" min="0" step="0.01" oninput="calculateTotal()" required/></div>
        <div class="group"><label>Total / Â∞èË®à</label><input name="itemTotal" readonly style="background:#f8fafc"/></div>
        <div class="group"><label>&nbsp;</label><button type="button" class="btn remove" title="Remove" onclick="removeItem(${itemCount})">√ó</button></div>`;
      document.getElementById('itemsContainer').appendChild(el);
      calculateTotal();
    }

    function removeItem(id){
      const row = document.getElementById(`item-${id}`);
      if(row && document.querySelectorAll('.item-row').length>1){
        row.remove();
        calculateTotal();
      }
    }

    function calculateTotal(){
      let total = 0;
      document.querySelectorAll('.item-row').forEach(row=>{
        const qty = parseFloat(row.querySelector('[name="qty"]').value) || 0;
        const price = parseFloat(row.querySelector('[name="unitPrice"]').value) || 0;
        const sub = qty * price;
        row.querySelector('[name="itemTotal"]').value = currency(sub).replace('HK$','');
        total += sub;
      });
      document.getElementById('totalAmount').textContent = currency(total);
    }

    // ===== Font loader (CJK-safe) =====
    // Place a TrueType font file (e.g., NotoSansTC-Regular.ttf) next to this HTML, or change the URL below.
    async function ensureCJKFont(doc){
      const fontName = 'NotoSansTC';
      if(doc.getFontList && doc.getFontList()[fontName]){
        doc.setFont(fontName, 'normal');
        return fontName;
      }
      // Try to load the font
      const url = './NotoSansTC-Regular.ttf'; // <<‚Äî Put your font file here
      const res = await fetch(url);
      if(!res.ok) throw new Error('Font file not found at '+url);
      const buf = await res.arrayBuffer();
      // Convert to base64
      const uint = new Uint8Array(buf);
      let binary = '';
      for(let i=0;i<uint.length;i++){ binary += String.fromCharCode(uint[i]); }
      const b64 = btoa(binary);
      // Register font with jsPDF
      doc.addFileToVFS('NotoSansTC-Regular.ttf', b64);
      doc.addFont('NotoSansTC-Regular.ttf', fontName, 'normal');
      doc.addFont('NotoSansTC-Regular.ttf', fontName, 'bold');
      doc.setFont(fontName, 'normal');
      return fontName;
    }

    // ===== PDF generation =====
    async function generatePDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'mm', format:'a4' });

      // Load and set CJK-safe font so Chinese + Latin align properly
      const fontName = await ensureCJKFont(doc);
      const margin = 16; // mm
      let y = margin;

      const form = new FormData(document.getElementById('invoiceForm'));
      const rows = [...document.querySelectorAll('.item-row')].map(row=>{
        const qty = parseFloat(row.querySelector('[name="qty"]').value)||0;
        const price = parseFloat(row.querySelector('[name="unitPrice"]').value)||0;
        const total = qty*price;
        return {
          itemNo: row.querySelector('[name="itemNo"]').value || '',
          desc: row.querySelector('[name="description"]').value || '',
          qty,
          unitPrice: price, total
        };
      });
      const grandTotal = rows.reduce((s,r)=>s+r.total,0);

      // Header
      doc.setFont(fontName, 'bold');
      doc.setFontSize(18);
      doc.text('Áé≤ÁìèÂúãÈöõ Exquis International', margin, y);
      doc.setFontSize(22);
      doc.text('INVOICE ÁôºÁ•®', 210 - margin - doc.getTextWidth('INVOICE ÁôºÁ•®'), y);
      y += 10;

      // Invoice meta
      doc.setFont(fontName, 'normal');
      doc.setFontSize(12);
      doc.text(`Invoice No ÁôºÁ•®ËôüÁ¢ºÔºö${form.get('invoiceNo')||''}`, margin, y);
      
      // Format date to DD/MM/YYYY
      const dateValue = form.get('invoiceDate') || '';
      let formattedDate = dateValue;
      if(dateValue) {
        const date = new Date(dateValue);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        formattedDate = `${day}/${month}/${year}`;
      }
      
      doc.text(`Date Êó•ÊúüÔºö${formattedDate}`, margin, y+7);
      y += 18;

      // Client
      doc.setFont(fontName, 'bold');
      const toLabelWidth = doc.getTextWidth('To Êî∂‰ª∂‰∫∫Ôºö');
      doc.text('To Êî∂‰ª∂‰∫∫Ôºö', margin, y);
      doc.setFont(fontName, 'normal');
      const toLines = doc.splitTextToSize(form.get('clientTo')||'', 210 - margin*2 - toLabelWidth - 5);
      doc.text(toLines, margin + toLabelWidth + 5, y);
      y += Math.max(toLines.length*6, 6) + 12;

      const addr = (form.get('clientAddress')||'').trim();
      if(addr){
        doc.setFont(fontName, 'bold'); 
        const addrLabelWidth = doc.getTextWidth('Address Âú∞ÂùÄÔºö');
        doc.text('Address Âú∞ÂùÄÔºö', margin, y);
        doc.setFont(fontName, 'normal');
        const addrLines = doc.splitTextToSize(addr, 210 - margin*2 - addrLabelWidth - 5);
        doc.text(addrLines, margin + addrLabelWidth + 5, y);
        y += Math.max(addrLines.length*6, 6) + 12;
      }

      const tel = (form.get('clientTel')||'').trim();
      if(tel){ 
        doc.setFont(fontName, 'bold'); 
        doc.text('Tel ÈõªË©±Ôºö', margin, y); 
        doc.setFont(fontName, 'normal');
        doc.text(tel, margin + doc.getTextWidth('Tel ÈõªË©±Ôºö') + 5, y); 
        y += 18; 
      }

      const attn = (form.get('clientAttn')||'').trim();
      if(attn){ 
        doc.setFont(fontName, 'bold'); 
        doc.text('Attn ËÅØÁµ°‰∫∫Ôºö', margin, y);
        doc.setFont(fontName, 'normal');
        doc.text(attn, margin + doc.getTextWidth('Attn ËÅØÁµ°‰∫∫Ôºö') + 5, y); 
        y += 18; 
      } else {
        y += 6;
      }

      // Table
      const head = [[ 'Item No.', 'Description / ÊèèËø∞', 'Qty / Êï∏Èáè', 'Unit Price / ÂñÆÂÉπ', 'Total / Â∞èË®à' ]];
      const body = rows.map(r=>[
        r.itemNo,
        r.desc,
        String(r.qty),
        (r.unitPrice).toFixed(2),
        (r.total).toFixed(2)
      ]);

      doc.autoTable({
        startY: y,
        head, body,
        styles: { font: fontName, fontSize: 10, cellPadding: 3, lineWidth: 0.3, lineColor: [0,0,0] },
        headStyles: { fillColor: [255,255,255], textColor: [0,0,0], fontStyle: 'bold' },
        bodyStyles: { fillColor: [255,255,255], textColor: [0,0,0] },
        columnStyles: {
          0: { halign: 'center', cellWidth: 18 },
          1: { cellWidth: 85 },
          2: { halign: 'right', cellWidth: 22 },
          3: { halign: 'right', cellWidth: 28 },
          4: { halign: 'right', cellWidth: 25 }
        },
        bodyStyles: { valign: 'top' },
        didParseCell: (data)=>{
          // Wrap long description nicely
          if(data.section==='body' && data.column.index===1){
            data.cell.styles.cellWidth = 85;
          }
        },
        margin: { left: margin, right: margin }
      });

      const afterTableY = doc.lastAutoTable.finalY + 8;

      // Payment Method
      const paymentMethod = (form.get('paymentMethod')||'').trim();
      if(paymentMethod){
        doc.setFont(fontName, 'bold');
        doc.text('Payment Method ‰ªòÊ¨æÊñπÂºèÔºö', margin, afterTableY);
        doc.setFont(fontName, 'normal');
        const paymentLines = doc.splitTextToSize(paymentMethod, 210 - margin*2);
        doc.text(paymentLines, margin, afterTableY + 7);
        y = afterTableY + 7 + paymentLines.length*6 + 4;
      } else {
        y = afterTableY;
      }

      // Total block
      doc.setFont(fontName, 'bold');
      doc.setFontSize(12);
      const label = 'Total Amount Á∏ΩÈáëÈ°çÔºöHKD $ ';
      const labelW = doc.getTextWidth(label);
      const amt = grandTotal.toFixed(2);
      const amtW = doc.getTextWidth(amt);
      const xRight = 210 - margin;
      doc.text(label, xRight - (labelW + amtW), y + 8);
      doc.text(amt, xRight - amtW, y + 8);

      // Save
      const fileName = `Invoice_${(form.get('invoiceNo')||'')}_${(form.get('invoiceDate')||'')}.pdf`;
      doc.save(fileName);
    }
  </script>
</body>
</html>
